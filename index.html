<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FixMap AI - –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/maintenance.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/maintenance.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overscroll-behavior-y: none; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #3b82f6; box-shadow: 0 0 10px #3b82f6; animation: scan 2s linear infinite; z-index: 10; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .chat-bubble { max-width: 80%; border-radius: 1rem; padding: 0.75rem 1rem; font-size: 0.9rem; line-height: 1.4; }
        .chat-user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; margin-left: auto; }
        .chat-ai { background-color: #f3f4f6; color: #1f2937; border-bottom-left-radius: 0.25rem; }
        /* Loader styles */
        #app-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ -->
    <div id="app-loader">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">–ó–∞–ø—É—Å–∫ FixMap...</h2>
        <p id="error-display" class="text-red-500 text-xs mt-4 px-4 text-center hidden"></p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        window.onerror = function(msg, url, line) {
            const errDiv = document.getElementById('error-display');
            errDiv.style.display = 'block';
            errDiv.innerText = `–û—à–∏–±–∫–∞: ${msg}`;
            return false;
        };

        const { useState, useEffect, useRef } = React;

        // --- –í–ê–® –ö–õ–Æ–ß GEMINI ---
        // –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–ª—é—á —Å—é–¥–∞, –∏–Ω–∞—á–µ –ò–ò –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!
        const apiKey = ""; 

        // --- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ---
        let auth = null;
        let db = null;
        let isFirebaseAvailable = false;
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –ø—Ä–µ–∂–¥–µ —á–µ–º –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            
            if (config) {
                if (!firebase.apps.length) firebase.initializeApp(config);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseAvailable = true;
            } else {
                console.warn("Firebase config not found. Running in demo mode.");
            }
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        const appId = 'fixmap-public-demo';

        // --- Utilities ---
        const pcmToWav = (base64PCM, sampleRate = 24000) => {
            const binaryString = atob(base64PCM);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const pcmData = new Int16Array(bytes.buffer);
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.byteLength, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);
            return new Blob([view, pcmData], { type: 'audio/wav' });
        };

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
                    if ((encoded.length % 4) > 0) { encoded += '='.repeat(4 - (encoded.length % 4)); }
                    resolve(encoded);
                };
                reader.onerror = error => reject(error);
            });
        };

        // --- Translations ---
        const translations = {
            ru: {
                welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
                app_subtitle: "–†–µ—à–∞–µ–º –≥–æ—Ä–æ–¥—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                report_btn: "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ",
                feed_title: "–õ–µ–Ω—Ç–∞ –ø—Ä–æ–±–ª–µ–º",
                no_reports: "–î–µ–º–æ-—Ä–µ–∂–∏–º: –∑–∞—è–≤–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î.",
                upload_title: "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞",
                take_photo: "–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ",
                gallery_hint: "–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏",
                analyzing: "–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...",
                result_title: "AI –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤",
                category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                severity: "–í–∞–∂–Ω–æ—Å—Ç—å",
                dept: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
                desc_title: "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                legal_btn: "–ò–ò-–Æ—Ä–∏—Å—Ç",
                audio_btn: "–û–∑–≤—É—á–∏—Ç—å",
                cost_btn: "–ë—é–¥–∂–µ—Ç",
                fio_label: "–§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è",
                address_label: "–ê–¥—Ä–µ—Å",
                submit_btn: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É",
                sending: "–û—Ç–ø—Ä–∞–≤–∫–∞...",
                chat_title: "–ì–æ—Ä–æ–¥—Å–∫–æ–π —Å–æ–≤–µ—Ç–Ω–∏–∫",
                chat_placeholder: "–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –∑–∞–∫–æ–Ω—ã...",
                cost_modal_title: "–û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏",
                demo_warning: "–í–Ω–∏–º–∞–Ω–∏–µ: –≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è. –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ.",
                solution_title: "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ"
            },
            ky: {
                welcome: "–ö–æ—à –∫–µ–ª–∏“£–∏–∑",
                app_subtitle: "–®–∞–∞—Ä–¥—ã–∫ –∫”©–π–≥”©–π–ª”©—Ä–¥“Ø —á–µ—á–µ–±–∏–∑",
                report_btn: "–ö”©–π–≥”©–π–¥“Ø –±–∏–ª–¥–∏—Ä“Ø“Ø",
                feed_title: "–ö”©–π–≥”©–π–ª”©—Ä —Ç“Ø—Ä–º”©–≥“Ø",
                no_reports: "–î–µ–º–æ —Ä–µ–∂–∏–º: –º–∞–∞–ª—ã–º–∞—Ç –±–∞–∑–∞—Å—ã –∂–æ–∫ —Å–∞–∫—Ç–∞–ª–±–∞–π—Ç.",
                upload_title: "–ñ–∞“£—ã –∞—Ä—ã–∑",
                take_photo: "–°“Ø—Ä”©—Ç–∫”© —Ç–∞—Ä—Ç—ã“£—ã–∑",
                gallery_hint: "–ñ–µ –≥–∞–ª–µ—Ä–µ—è–¥–∞–Ω —Ç–∞–Ω–¥–∞“£—ã–∑",
                analyzing: "–°“Ø—Ä”©—Ç—Ç“Ø —Ç–∞–ª–¥–æ–æ...",
                result_title: "AI –¢–∞–ª–¥–æ–æ –¥–∞—è—Ä",
                category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                severity: "–ú–∞–∞–Ω–∏–ª“Ø“Ø–ª“Ø–≥“Ø",
                dept: "–ñ–æ–æ–ø—Ç—É—É",
                desc_title: "–ö”©–π–≥”©–π–¥“Ø–Ω —Å“Ø—Ä”©—Ç—Ç”©–ª“Ø—à“Ø",
                legal_btn: "AI-–Æ—Ä–∏—Å—Ç",
                audio_btn: "–£–≥—É—É",
                cost_btn: "–ë–∞–∞–ª–æ–æ",
                fio_label: "–ê—Ç—ã-–∂”©–Ω“Ø",
                address_label: "–î–∞—Ä–µ–∫",
                submit_btn: "–ê—Ä—ã–∑–¥—ã –∂”©–Ω”©—Ç“Ø“Ø",
                sending: "–ñ”©–Ω”©—Ç“Ø–ª“Ø“Ø–¥”©...",
                chat_title: "–®–∞–∞—Ä–¥—ã–∫ –∫–µ“£–µ—à—á–∏",
                chat_placeholder: "–ú—ã–π–∑–∞–º–¥–∞—Ä –∂”©–Ω“Ø–Ω–¥”© —Å—É—Ä–∞“£—ã–∑...",
                cost_modal_title: "–û“£–¥–æ–æ –±–∞–∞—Å—ã",
                demo_warning: "–î–µ–º–æ –≤–µ—Ä—Å–∏—è: –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –±—É–ª—É—Ç—Ç–∞ —Å–∞–∫—Ç–∞–ª–±–∞–π—Ç.",
                solution_title: "–¢–µ—Ö–Ω–∏–∫–∞–ª—ã–∫ —á–µ—á–∏–º"
            }
        };

        // --- Gemini Services ---
        const callGemini = async (payload, endpoint = "generateContent") => {
            if (!apiKey) throw new Error("API Key is missing in code!");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:${endpoint}?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Gemini API Error: " + response.statusText);
            return await response.json();
        };

        const analyzeImageWithGemini = async (file, lang) => {
            const base64Image = await fileToBase64(file);
            const prompt = `–¢—ã - –ò–ò-–∏–Ω–∂–µ–Ω–µ—Ä –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–∏—Ö —Å–ª—É–∂–±. –Ø–∑—ã–∫: ${lang === 'ky' ? '–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π' : '–†—É—Å—Å–∫–∏–π'}.
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ —Ñ–æ—Ç–æ.
            –í–µ—Ä–Ω–∏ JSON:
            {
                "type": "–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã",
                "category": "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                "dept": "–°–ª—É–∂–±–∞ (–¢–∞–∑–∞–ª—ã–∫, –ó–µ–ª–µ–Ω—Å—Ç—Ä–æ–π –∏ —Ç.–¥.)",
                "severity": "–í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è/–ù–∏–∑–∫–∞—è",
                "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1 –ø—Ä–µ–¥–ª)",
                "safety_tips": "–°–æ–≤–µ—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
                "consequences": "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é",
                "solution": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–∫–∞–∫ —á–∏–Ω–∏—Ç—å)",
                "icon": "AlertTriangle"
            }`;
            
            const data = await callGemini({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Image } }] }] });
            const text = data.candidates[0].content.parts[0].text;
            return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
        };

        const App = () => {
            const [view, setView] = useState('lang_select');
            const [lang, setLang] = useState('ru');
            const [reports, setReports] = useState([]); // Local state for demo
            
            // Data
            const [selectedFile, setSelectedFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [analysisLoading, setAnalysisLoading] = useState(false);
            
            // Chat
            const [showChat, setShowChat] = useState(false);
            const [chatMsg, setChatMsg] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);

            const T = translations[lang];

            useEffect(() => {
                // Hide loader once App mounts
                const loader = document.getElementById('app-loader');
                if(loader) loader.style.display = 'none';
                
                // Auth anonymously if Firebase is available
                if (isFirebaseAvailable && auth) {
                    auth.signInAnonymously().catch(console.error);
                }
                
                // Init icons
                lucide.createIcons();
            }, []);

            // Firebase Listener (Only if configured)
            useEffect(() => {
                if (isFirebaseAvailable && db) {
                     const q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').orderBy('createdAt', 'desc').limit(20);
                     const unsub = q.onSnapshot(s => setReports(s.docs.map(d => ({id: d.id, ...d.data()}))), err => console.log("Firestore read error (expected if permissions off)", err));
                     return () => unsub();
                }
            }, []);

            const handleFileSelect = async (e) => {
                if (e.target.files?.[0]) {
                    const file = e.target.files[0];
                    setSelectedFile(file);
                    setPreviewUrl(URL.createObjectURL(file));
                    setView('analyzing');
                    setAnalysisLoading(true);
                    
                    try {
                        // Simulate delay for effect
                        await new Promise(r => setTimeout(r, 1500));
                        if (!apiKey) throw new Error("API Key –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–¥–µ!");
                        
                        const result = await analyzeImageWithGemini(file, lang);
                        setAiAnalysis(result);
                        setAnalysisLoading(false);
                        setView('result');
                    } catch (err) {
                        alert("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: " + err.message);
                        setView('upload');
                    }
                }
            };

            const submitReport = async () => {
                const newReport = {
                    ...aiAnalysis,
                    createdAt: new Date(),
                    status: '–ù–æ–≤–∞—è',
                    id: Date.now().toString()
                };
                
                if (isFirebaseAvailable && db) {
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').add({
                            ...newReport,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞). –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.");
                        setReports([newReport, ...reports]);
                    }
                } else {
                    // Local demo save
                    setReports([newReport, ...reports]);
                }
                
                setView('home');
            };

            // --- Chat ---
            const sendChat = async (e) => {
                e.preventDefault();
                if(!chatInput.trim()) return;
                const userText = chatInput;
                setChatMsg(prev => [...prev, {role: 'user', text: userText}]);
                setChatInput('');
                setChatLoading(true);
                
                try {
                    const prompt = `–¢—ã - –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å–æ–≤–µ—Ç–Ω–∏–∫ (–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω). –Ø–∑—ã–∫: ${lang}. –í–æ–ø—Ä–æ—Å: ${userText}`;
                    const data = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
                    const reply = data.candidates[0].content.parts[0].text;
                    setChatMsg(prev => [...prev, {role: 'user', text: userText}, {role: 'ai', text: reply}]);
                } catch(e) {
                    setChatMsg(prev => [...prev, {role: 'ai', text: "–û—à–∏–±–∫–∞: " + e.message}]);
                }
                setChatLoading(false);
            };

            // --- Renders ---
            const Icon = ({name, size=20, className}) => <i data-lucide={name} width={size} height={size} className={className}></i>;

            if (view === 'lang_select') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-800 p-6 text-white text-center">
                        <div className="bg-white/10 backdrop-blur-md p-8 rounded-3xl border border-white/20 shadow-2xl w-full max-w-sm">
                            <i data-lucide="globe" className="w-12 h-12 mx-auto mb-4 text-blue-200"></i>
                            <h1 className="text-3xl font-bold mb-8">FixMap AI</h1>
                            <button onClick={() => {setLang('ky'); setView('home');}} className="w-full bg-white text-blue-800 font-bold py-4 rounded-xl mb-3 hover:bg-blue-50 transition">–ö—ã—Ä–≥—ã–∑—á–∞ üá∞üá¨</button>
                            <button onClick={() => {setLang('ru'); setView('home');}} className="w-full bg-blue-500/50 border border-white/30 text-white font-bold py-4 rounded-xl hover:bg-blue-500/70 transition">–†—É—Å—Å–∫–∏–π üá∑üá∫</button>
                        </div>
                    </div>
                );
            }

            if (view === 'analyzing') {
                return (
                    <div className="h-screen bg-gray-900 flex flex-col items-center justify-center relative overflow-hidden">
                         {previewUrl && <img src={previewUrl} className="absolute inset-0 w-full h-full object-cover opacity-40 blur-sm" />}
                         <div className="scan-line"></div>
                         <div className="relative z-10 text-center">
                             <div className="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                             <p className="text-white font-bold text-xl">{T.analyzing}</p>
                         </div>
                    </div>
                );
            }

            if (view === 'result' && aiAnalysis) {
                return (
                    <div className="min-h-screen bg-gray-50 pb-8">
                        <div className="relative h-64 bg-gray-900">
                            <img src={previewUrl} className="w-full h-full object-cover opacity-90" />
                            <button onClick={() => setView('upload')} className="absolute top-4 left-4 bg-black/40 p-2 rounded-full text-white backdrop-blur-md"><Icon name="arrow-left"/></button>
                            <div className="absolute bottom-0 w-full p-6 bg-gradient-to-t from-black/80 to-transparent">
                                <span className="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded mb-2 inline-block">{T.result_title}</span>
                                <h2 className="text-2xl font-bold text-white">{aiAnalysis.type}</h2>
                            </div>
                        </div>
                        <div className="p-6 -mt-6 bg-gray-50 rounded-t-3xl relative z-10 space-y-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="bg-blue-50 p-3 rounded-xl"><div className="text-xs text-gray-500">{T.category}</div><div className="font-bold">{aiAnalysis.category}</div></div>
                                    <div className="bg-red-50 p-3 rounded-xl"><div className="text-xs text-gray-500">{T.severity}</div><div className="font-bold">{aiAnalysis.severity}</div></div>
                                </div>
                                <div className="mb-3"><div className="text-xs text-gray-400 font-bold uppercase">{T.desc_title}</div><p className="text-sm text-gray-700">{aiAnalysis.description}</p></div>
                                <div><div className="text-xs text-gray-400 font-bold uppercase">{T.solution_title}</div><p className="text-sm text-gray-700">{aiAnalysis.solution}</p></div>
                            </div>
                            <button onClick={submitReport} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">{T.submit_btn}</button>
                        </div>
                    </div>
                );
            }

            // Home & Upload View
            return (
                <div className="min-h-screen bg-gray-50 pb-24 relative">
                    {/* Header */}
                    <div className="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-6 rounded-b-[2.5rem] shadow-xl relative z-10">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2 font-bold text-xl"><span className="bg-white/20 p-1 rounded"><Icon name="sparkles" size={16}/></span> FixMap</div>
                            <button onClick={() => setView('lang_select')} className="text-xs bg-white/20 px-3 py-1 rounded-full">{lang.toUpperCase()}</button>
                        </div>
                        <h1 className="text-3xl font-extrabold mb-2">{T.app_subtitle}</h1>
                        {!isFirebaseAvailable && <p className="text-xs text-yellow-200 bg-yellow-900/30 p-2 rounded inline-block">{T.demo_warning}</p>}
                        
                        <div className="mt-6 flex gap-3">
                             <label className="flex-1 bg-white text-blue-700 font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 cursor-pointer active:scale-95 transition">
                                <Icon name="camera"/> {T.take_photo}
                                <input type="file" accept="image/*" className="hidden" onChange={handleFileSelect} />
                            </label>
                        </div>
                    </div>

                    {/* Feed */}
                    <div className="p-4 pt-6">
                        <h2 className="font-bold text-gray-800 mb-4 px-2">{T.feed_title}</h2>
                        {reports.length === 0 ? (
                            <div className="text-center text-gray-400 py-10 flex flex-col items-center">
                                <Icon name="inbox" size={48} className="mb-2 opacity-50"/>
                                <p>{T.no_reports}</p>
                            </div>
                        ) : (
                            reports.map(r => (
                                <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3 flex gap-3">
                                    <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shrink-0"><Icon name="alert-circle"/></div>
                                    <div>
                                        <h3 className="font-bold text-gray-800">{r.type}</h3>
                                        <p className="text-xs text-gray-500 line-clamp-2">{r.description}</p>
                                        <div className="flex gap-2 mt-2">
                                            <span className="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-600">{r.status}</span>
                                            <span className="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-600">{r.category}</span>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* Chat Button */}
                    <button onClick={() => setShowChat(!showChat)} className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 transition z-50">
                        <Icon name="message-circle" size={28}/>
                    </button>

                    {/* Chat Modal */}
                    {showChat && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm h-[500px] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                                    <h3 className="font-bold">{T.chat_title}</h3>
                                    <button onClick={() => setShowChat(false)}><Icon name="x"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {chatMsg.length === 0 && <p className="text-center text-gray-400 text-sm mt-10">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!</p>}
                                    {chatMsg.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-3 rounded-2xl max-w-[80%] text-sm ${m.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'}`}>{m.text}</div>
                                        </div>
                                    ))}
                                    {chatLoading && <div className="text-xs text-gray-400 animate-pulse">–ü–µ—á–∞—Ç–∞–µ—Ç...</div>}
                                </div>
                                <form onSubmit={sendChat} className="p-3 border-t flex gap-2">
                                    <input value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder={T.chat_placeholder} className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none"/>
                                    <button type="submit" className="bg-blue-600 text-white p-2 rounded-full"><Icon name="send" size={18}/></button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>